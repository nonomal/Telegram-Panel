@namespace TelegramPanel.Web.Components.Dialogs
@inject AccountManagementService AccountManagement
@inject AccountCategoryManagementService CategoryManagement
@inject TelegramPanel.Core.Services.AccountRiskService RiskService
@inject BatchTaskManagementService TaskManagement
@inject TelegramPanel.Web.Modules.ModuleContributionRegistry Contributions
@inject ISnackbar Snackbar
@inject IDialogService DialogService
@inject NavigationManager Navigation
@using System.Text.Json
@using Microsoft.AspNetCore.Components
@using TelegramPanel.Core.BatchTasks
@using TelegramPanel.Data.Entities
@using TelegramPanel.Web.Modules

<MudDialog>
    <DialogContent>
        <MudStack Spacing="2">
            <MudAlert Severity="Severity.Info" Variant="Variant.Outlined" Dense="true">
                任务会提交到后台执行，可在【任务中心】查看进度与结果。
            </MudAlert>

            <MudGrid>
                <MudItem xs="12" md="6">
                <MudSelect @bind-Value="selectedCategory" Label="任务分类" Variant="Variant.Outlined" Dense="true">
                    @foreach (var c in AvailableCategories)
                    {
                        <MudSelectItem Value="@c">@GetCategoryDisplayName(c)</MudSelectItem>
                    }
                </MudSelect>
                </MudItem>
                <MudItem xs="12" md="6">
                    <MudSelect @bind-Value="selectedTaskType" Label="任务类型" Variant="Variant.Outlined" Dense="true">
                        @foreach (var opt in AvailableOptions)
                        {
                            <MudSelectItem Value="@opt.TaskType">@opt.DisplayName</MudSelectItem>
                        }
                    </MudSelect>
                </MudItem>
            </MudGrid>

            @if (CurrentOption != null && !string.IsNullOrWhiteSpace(CurrentOption.Description))
            {
                <MudText Typo="Typo.caption" Class="mud-text-secondary">@CurrentOption.Description</MudText>
            }

            @if (selectedTaskType == BatchTaskTypes.UserJoinSubscribe)
            {
                <MudDivider Class="my-2" />

                <MudAlert Severity="Severity.Warning" Variant="Variant.Outlined" Dense="true">
                    批量订阅频道/加群（用户任务）：支持输入多个链接/用户名，换行分隔。支持：<b>https://t.me/xxx</b>、<b>t.me/+hash</b>、<b>@@username</b>、<b>username</b>、<b>tg://join?invite=hash</b>。
                </MudAlert>

                <MudTextField @bind-Value="linksText" Label="频道/群链接列表（换行分隔）" Variant="Variant.Outlined" Lines="8"
                              HelperText="每行一个链接或用户名；将对所选账号逐个执行订阅/加入。" />

                <MudNumericField @bind-Value="delayMs" Label="操作间隔（毫秒）" Variant="Variant.Outlined" Min="0" Max="10000"
                                 HelperText="建议设置 1500-4000ms，避免触发风控（会额外加少量随机抖动）。" />

                <MudStack direction="Row" AlignItems="AlignItems.Center" Spacing="2">
                    <MudText Typo="Typo.subtitle2">选择执行账号：@selectedAccounts.Count / @accounts.Count</MudText>
                    <MudSpacer />
                    <MudButton Variant="Variant.Outlined" Color="Color.Primary" OnClick="SelectAll" Disabled="@(accounts.Count == 0)">全选当前筛选</MudButton>
                    <MudButton Variant="Variant.Text" Color="Color.Secondary" OnClick="ClearSelection" Disabled="@(selectedAccounts.Count == 0)">清空</MudButton>
                </MudStack>

                <MudGrid>
                    <MudItem xs="12" md="4">
                        <MudSelect @bind-Value="filterAccountCategoryId" Label="账号分类筛选" Variant="Variant.Outlined" Dense="true" Style="min-width: 160px;">
                            <MudSelectItem Value="0">全部分类</MudSelectItem>
                            <MudSelectItem Value="-1">未分类</MudSelectItem>
                            @foreach (var c in categories)
                            {
                                <MudSelectItem Value="@c.Id">@c.Name</MudSelectItem>
                            }
                        </MudSelect>
                    </MudItem>
                    <MudItem xs="12" md="8">
                        <MudTextField @bind-Value="accountSearch" Placeholder="搜索账号（手机号/昵称/用户名）" Variant="Variant.Outlined"
                                      Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.Search" Immediate="true" />
                    </MudItem>
                </MudGrid>

                <MudTable Items="@FilteredAccounts" Dense="true" Hover="true" Breakpoint="Breakpoint.Sm"
                          MultiSelection="true" @bind-SelectedItems="selectedAccounts" Loading="@loadingAccounts">
                    <HeaderContent>
                        <MudTh>手机号</MudTh>
                        <MudTh>昵称</MudTh>
                        <MudTh>用户名</MudTh>
                        <MudTh>分类</MudTh>
                    </HeaderContent>
                    <RowTemplate>
                        <MudTd DataLabel="手机号">@context.Phone</MudTd>
                        <MudTd DataLabel="昵称">@(string.IsNullOrWhiteSpace(context.Nickname) ? "-" : context.Nickname)</MudTd>
                        <MudTd DataLabel="用户名">@(string.IsNullOrWhiteSpace(context.Username) ? "-" : "@" + context.Username)</MudTd>
                        <MudTd DataLabel="分类">@GetAccountCategoryName(context.CategoryId)</MudTd>
                    </RowTemplate>
                    <NoRecordsContent>
                        <MudText>暂无账号</MudText>
                    </NoRecordsContent>
                </MudTable>
            }
            else if (CurrentOption != null && !string.IsNullOrWhiteSpace(CurrentOption.CreateRoute))
            {
                <MudAlert Severity="Severity.Info" Variant="Variant.Outlined" Dense="true">
                    该任务建议使用独立页面创建：<b>@CurrentOption.CreateRoute</b>
                </MudAlert>
                <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="@(() => NavigateTo(CurrentOption.CreateRoute!))">
                    前往创建
                </MudButton>
            }
            else if (CurrentOption != null && !string.IsNullOrWhiteSpace(CurrentOption.EditorComponentType) && editorComponentType != null)
            {
                <MudAlert Severity="Severity.Info" Variant="Variant.Outlined" Dense="true">
                    该任务由模块提供自定义创建器。
                </MudAlert>

                <DynamicComponent Type="editorComponentType" Parameters="editorParameters" />

                @if (!string.IsNullOrWhiteSpace(editorDraft.ValidationError))
                {
                    <MudText Typo="Typo.caption" Color="Color.Error">@editorDraft.ValidationError</MudText>
                }
            }
            else
            {
                <MudAlert Severity="Severity.Info" Variant="Variant.Outlined" Dense="true">
                    该任务类型暂无专用创建表单。你可以填写通用配置（JSON 字符串）提交任务；对应模块需要在后台实现该 TaskType 的执行器。
                </MudAlert>

                <MudTextField @bind-Value="genericConfigJson" Label="任务配置（JSON）" Variant="Variant.Outlined" Lines="8"
                              HelperText="模块可自行解析该 JSON。若无需配置可留空。" />

                <MudNumericField @bind-Value="genericTotal" Label="总数（Total，可选）" Variant="Variant.Outlined" Min="0" Max="1000000"
                                 HelperText="用于进度条展示；若不确定可填 0，由执行器在运行时持续更新进度。" />
            }
        </MudStack>
    </DialogContent>
    <DialogActions>
        <MudButton Variant="Variant.Text" Color="Color.Default" OnClick="Cancel" Disabled="@creating">关闭</MudButton>
        <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="Create" Disabled="@creating">
            @if (creating)
            {
                <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                <span>提交中...</span>
            }
            else
            {
                <span>提交任务</span>
            }
        </MudButton>
    </DialogActions>
</MudDialog>

@code
{
    [CascadingParameter] private MudDialogInstance MudDialog { get; set; } = default!;

    private string _selectedCategory = "";
    private string selectedCategory
    {
        get => _selectedCategory;
        set
        {
            value = (value ?? "").Trim();
            if (string.Equals(_selectedCategory, value, StringComparison.OrdinalIgnoreCase))
                return;
            _selectedCategory = value;
            EnsureTaskTypeValid();
        }
    }
    private string selectedTaskType = "";

    private bool creating;

    // join/subscribe config
    private string linksText = "";
    private int delayMs = 2000;

    // generic task config
    private string genericConfigJson = "";
    private int genericTotal = 0;

    // module editor draft
    private TelegramPanel.Modules.ModuleTaskDraft editorDraft = new(0, null, false, null);
    private Type? editorComponentType;
    private Dictionary<string, object?> editorParameters = new();

    private bool loadingAccounts;
    private List<Account> accounts = new();
    private List<AccountCategory> categories = new();
    private string accountSearch = "";
    private int filterAccountCategoryId = 0;
    private HashSet<Account> selectedAccounts = new();

    private IEnumerable<string> AvailableCategories =>
        Contributions.Tasks
            .Select(x => (x.Definition.Category ?? "").Trim())
            .Where(x => x.Length > 0)
            .Where(x => !IsSystemCategory(x))
            .Distinct(StringComparer.OrdinalIgnoreCase)
            .OrderBy(x => x, StringComparer.OrdinalIgnoreCase);

    private IEnumerable<TelegramPanel.Modules.ModuleTaskDefinition> AvailableOptions =>
        Contributions.Tasks
            .Select(x => x.Definition)
            .Where(o => !IsSystemCategory(o.Category))
            .Where(o => string.Equals(o.Category, selectedCategory, StringComparison.OrdinalIgnoreCase))
            .OrderBy(o => o.Order)
            .ThenBy(o => o.DisplayName);

    private TelegramPanel.Modules.ModuleTaskDefinition? CurrentOption =>
        !string.IsNullOrWhiteSpace(selectedTaskType)
        && Contributions.TaskTypeToDefinition.TryGetValue(selectedTaskType, out var reg)
            ? reg.Definition
            : null;

    private IEnumerable<Account> FilteredAccounts =>
        accounts.Where(a =>
        {
            if (filterAccountCategoryId > 0 && a.CategoryId != filterAccountCategoryId)
                return false;
            if (filterAccountCategoryId == -1 && a.CategoryId != null)
                return false;

            if (string.IsNullOrWhiteSpace(accountSearch))
                return true;
            var q = accountSearch.Trim();
            return a.Phone.Contains(q, StringComparison.OrdinalIgnoreCase)
                   || (a.Nickname?.Contains(q, StringComparison.OrdinalIgnoreCase) ?? false)
                   || (a.Username?.Contains(q, StringComparison.OrdinalIgnoreCase) ?? false);
        });

    protected override async Task OnInitializedAsync()
    {
        if (string.IsNullOrWhiteSpace(selectedCategory))
            selectedCategory = AvailableCategories.FirstOrDefault() ?? "user";

        EnsureTaskTypeValid();
        ResolveEditorComponent();
        await LoadCategories();
        await LoadAccounts();
    }

    private async Task LoadCategories()
    {
        try
        {
            var list = await CategoryManagement.GetAllCategoriesAsync();
            categories = list.OrderBy(c => c.Id).ToList();
        }
        catch
        {
            categories = new List<AccountCategory>();
        }
    }

    private async Task LoadAccounts()
    {
        loadingAccounts = true;
        try
        {
            var list = await AccountManagement.GetActiveAccountsAsync();
            accounts = list.OrderBy(a => a.Id).ToList();
            selectedAccounts = selectedAccounts.Where(a => accounts.Any(x => x.Id == a.Id)).ToHashSet();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"加载账号失败：{ex.Message}", Severity.Error);
        }
        finally
        {
            loadingAccounts = false;
        }
    }

    private void EnsureTaskTypeValid()
    {
        if (AvailableOptions.All(o => !string.Equals(o.TaskType, selectedTaskType, StringComparison.OrdinalIgnoreCase)))
        {
            selectedTaskType = AvailableOptions.FirstOrDefault()?.TaskType
                               ?? Contributions.Tasks.FirstOrDefault()?.Definition.TaskType
                               ?? BatchTaskTypes.UserJoinSubscribe;
        }

        ResolveEditorComponent();
    }

    private static string GetCategoryDisplayName(string category) => category switch
    {
        "user" => "用户任务",
        "bot" => "Bot 任务",
        "system" => "系统任务",
        _ => string.IsNullOrWhiteSpace(category) ? "-" : category
    };

    private static bool IsSystemCategory(string? category) =>
        string.Equals((category ?? "").Trim(), "system", StringComparison.OrdinalIgnoreCase);

    private void ResolveEditorComponent()
    {
        editorComponentType = null;
        editorParameters = new Dictionary<string, object?>();
        editorDraft = new TelegramPanel.Modules.ModuleTaskDraft(0, null, false, null);

        var opt = CurrentOption;
        if (opt == null || string.IsNullOrWhiteSpace(opt.EditorComponentType))
            return;

        if (!Contributions.TaskTypeToDefinition.TryGetValue(opt.TaskType, out var reg))
            return;

        var typeName = opt.EditorComponentType.Trim();
        editorComponentType =
            Type.GetType(typeName, throwOnError: false, ignoreCase: false)
            ?? reg.Module.Instance.GetType().Assembly.GetType(typeName, throwOnError: false, ignoreCase: false);

        if (editorComponentType == null)
            return;

        editorParameters = new Dictionary<string, object?>
        {
            ["Draft"] = editorDraft,
            ["DraftChanged"] = EventCallback.Factory.Create<TelegramPanel.Modules.ModuleTaskDraft>(this, OnEditorDraftChanged)
        };
    }

    private void OnEditorDraftChanged(TelegramPanel.Modules.ModuleTaskDraft draft)
    {
        editorDraft = draft;
    }

    private void SelectAll() => selectedAccounts = FilteredAccounts.ToHashSet();
    private void ClearSelection() => selectedAccounts = new HashSet<Account>();

    private string GetAccountCategoryName(int? categoryId)
    {
        if (categoryId is not > 0)
            return "未分类";
        return categories.FirstOrDefault(c => c.Id == categoryId)?.Name ?? $"#{categoryId}";
    }

    private async Task Create()
    {
        if (creating)
            return;

        EnsureTaskTypeValid();

        if (CurrentOption != null && !string.IsNullOrWhiteSpace(CurrentOption.CreateRoute))
        {
            Snackbar.Add("该任务建议使用独立页面创建，请点击“前往创建”。", Severity.Info);
            return;
        }

        if (CurrentOption != null && !string.IsNullOrWhiteSpace(CurrentOption.EditorComponentType) && editorComponentType != null)
        {
            if (!editorDraft.CanSubmit)
            {
                Snackbar.Add(string.IsNullOrWhiteSpace(editorDraft.ValidationError) ? "请先完善任务配置" : editorDraft.ValidationError!, Severity.Warning);
                return;
            }

            creating = true;
            try
            {
                var task = new BatchTask
                {
                    TaskType = selectedTaskType,
                    Total = editorDraft.Total,
                    Completed = 0,
                    Failed = 0,
                    Config = editorDraft.Config
                };

                var created = await TaskManagement.CreateTaskAsync(task);
                Snackbar.Add($"已提交后台任务 #{created.Id}（{selectedTaskType}）。请到【任务中心】查看进度。", Severity.Success);
                MudDialog.Close(DialogResult.Ok(created.Id));
            }
            catch (Exception ex)
            {
                Snackbar.Add($"提交失败：{ex.Message}", Severity.Error);
            }
            finally
            {
                creating = false;
            }

            return;
        }

        if (string.Equals(selectedTaskType, BatchTaskTypes.UserJoinSubscribe, StringComparison.OrdinalIgnoreCase))
        {
            var links = ParseLines(linksText);
            if (links.Count == 0)
            {
                Snackbar.Add("请至少输入一个频道/群链接", Severity.Warning);
                return;
            }

            var selected = selectedAccounts.ToList();
            if (selected.Count == 0)
            {
                Snackbar.Add("请至少选择一个执行账号", Severity.Warning);
                return;
            }

            // 批量风控检查：加入群/订阅频道是敏感操作
            var batchCheck = RiskService.CheckBatchAccounts(selected);
            if (batchCheck.HasRiskyAccounts)
            {
                var parameters = new DialogParameters
                {
                    ["Message"] = $"检测到 {batchCheck.RiskyCount} 个风险账号",
                    ["DetailedMessage"] = batchCheck.GetRiskySummary(),
                    ["ShowRecommendations"] = true,
                    ["ShowExcludeOption"] = true,
                    ["RiskyAccounts"] = batchCheck.RiskyAccounts.ToList()
                };
                var options = new DialogOptions { CloseOnEscapeKey = true, MaxWidth = MaxWidth.Large };
                var dialog = DialogService.Show<TelegramPanel.Web.Components.Dialogs.RiskWarningDialog>("批量操作风控警告", parameters, options);
                var result = await dialog.Result;

                if (result.Canceled)
                    return;

                if (result.Data is TelegramPanel.Core.Services.RiskWarningAction action
                    && action == TelegramPanel.Core.Services.RiskWarningAction.ExcludeRisky)
                {
                    selected = batchCheck.SafeAccounts.ToList();
                    if (selected.Count == 0)
                    {
                        Snackbar.Add("排除风险账号后无剩余账号", Severity.Info);
                        return;
                    }
                }
            }

            bool? confirm = await DialogService.ShowMessageBox(
                "确认提交任务",
                $"将对 {selected.Count} 个账号执行 {links.Count} 个链接的订阅/加群操作，总计 {selected.Count * links.Count} 次。是否继续？",
                yesText: "继续", cancelText: "取消");

            if (confirm != true)
                return;

            creating = true;
            try
            {
                var ids = selected.Select(a => a.Id).Distinct().ToList();
                var task = new BatchTask
                {
                    TaskType = BatchTaskTypes.UserJoinSubscribe,
                    Total = ids.Count * links.Count,
                    Completed = 0,
                    Failed = 0,
                    Config = JsonSerializer.Serialize(new
                    {
                        AccountIds = ids,
                        Links = links,
                        DelayMs = delayMs
                    })
                };

                var created = await TaskManagement.CreateTaskAsync(task);
                Snackbar.Add($"已提交后台任务 #{created.Id}（批量订阅/加群）。请到【任务中心】查看进度。", Severity.Success);
                MudDialog.Close(DialogResult.Ok(created.Id));
            }
            catch (Exception ex)
            {
                Snackbar.Add($"提交失败：{ex.Message}", Severity.Error);
            }
            finally
            {
                creating = false;
            }

            return;
        }

        // Generic task create
        if (!string.IsNullOrWhiteSpace(genericConfigJson))
        {
            try
            {
                JsonDocument.Parse(genericConfigJson);
            }
            catch (Exception ex)
            {
                Snackbar.Add($"配置 JSON 无效：{ex.Message}", Severity.Warning);
                return;
            }
        }

        bool? genericConfirm = await DialogService.ShowMessageBox(
            "确认提交任务",
            $"将提交任务类型：{selectedTaskType}。是否继续？",
            yesText: "继续", cancelText: "取消");

        if (genericConfirm != true)
            return;

        creating = true;
        try
        {
            var task = new BatchTask
            {
                TaskType = selectedTaskType,
                Total = genericTotal,
                Completed = 0,
                Failed = 0,
                Config = string.IsNullOrWhiteSpace(genericConfigJson) ? null : genericConfigJson.Trim()
            };

            var created = await TaskManagement.CreateTaskAsync(task);
            Snackbar.Add($"已提交后台任务 #{created.Id}（{selectedTaskType}）。请到【任务中心】查看进度。", Severity.Success);
            MudDialog.Close(DialogResult.Ok(created.Id));
        }
        catch (Exception ex)
        {
            Snackbar.Add($"提交失败：{ex.Message}", Severity.Error);
        }
        finally
        {
            creating = false;
        }
    }

    private void NavigateTo(string url)
    {
        MudDialog.Close();
        Navigation.NavigateTo(url);
    }

    private static List<string> ParseLines(string? text)
    {
        if (string.IsNullOrWhiteSpace(text))
            return new List<string>();

        return text
            .Split(new[] { "\r\n", "\n", "\r" }, StringSplitOptions.RemoveEmptyEntries)
            .Select(x => (x ?? string.Empty).Trim())
            .Where(x => !string.IsNullOrWhiteSpace(x))
            .Distinct(StringComparer.OrdinalIgnoreCase)
            .ToList();
    }

    private void Cancel() => MudDialog.Close();
}
