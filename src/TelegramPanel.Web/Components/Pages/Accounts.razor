@page "/accounts"
@inject AccountManagementService AccountManagement
@inject AccountCategoryManagementService CategoryManagement
@inject ISnackbar Snackbar
@inject IDialogService DialogService
@using TelegramPanel.Data.Entities

<PageTitle>账号列表 - Telegram Panel</PageTitle>

<MudText Typo="Typo.h4" Class="mb-4">账号列表</MudText>

<MudCard>
    <MudCardContent>
        <MudTable Items="@filteredAccounts" Hover="true" Breakpoint="Breakpoint.Sm" Loading="@loading">
            <ToolBarContent>
                <MudText Typo="Typo.h6">已导入账号 (@accounts.Count)</MudText>
                <MudSpacer />
                <MudSelect @bind-Value="filterCategoryId" Label="分类" Variant="Variant.Outlined" Dense="true" Class="mr-2" Style="min-width: 160px;">
                    <MudSelectItem Value="0">全部分类</MudSelectItem>
                    @foreach (var c in categories)
                    {
                        <MudSelectItem Value="@c.Id">@c.Name</MudSelectItem>
                    }
                </MudSelect>
                <MudTextField @bind-Value="searchString" Placeholder="搜索账号..." Adornment="Adornment.Start"
                              AdornmentIcon="@Icons.Material.Filled.Search" IconSize="Size.Medium" Class="mt-0"
                              Immediate="true" />
                <MudButton Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Refresh"
                           OnClick="LoadAccounts" Class="ml-2">刷新</MudButton>
            </ToolBarContent>
            <HeaderContent>
                <MudTh>手机号</MudTh>
                <MudTh>昵称</MudTh>
                <MudTh>用户名</MudTh>
                <MudTh>用户ID</MudTh>
                <MudTh>分类</MudTh>
                <MudTh>频道/群组</MudTh>
                <MudTh>状态</MudTh>
                <MudTh>最后同步</MudTh>
                <MudTh>操作</MudTh>
            </HeaderContent>
            <RowTemplate>
                <MudTd DataLabel="手机号">@context.Phone</MudTd>
                <MudTd DataLabel="昵称">@(context.Nickname ?? "-")</MudTd>
                <MudTd DataLabel="用户名">@(context.Username ?? "-")</MudTd>
                <MudTd DataLabel="用户ID">@context.UserId</MudTd>
                <MudTd DataLabel="分类">
                    @if (context.Category != null)
                    {
                        <MudChip T="string" Size="Size.Small" Style="@($"background-color: {context.Category.Color ?? "#9E9E9E"}")">
                            @context.Category.Name
                        </MudChip>
                    }
                    else
                    {
                        <MudText Typo="Typo.body2" Color="Color.Default">未分类</MudText>
                    }
                </MudTd>
                <MudTd DataLabel="频道/群组">
                    <MudText Typo="Typo.body2">@context.Channels.Count / @context.Groups.Count</MudText>
                </MudTd>
                <MudTd DataLabel="状态">
                    <MudChip T="string" Size="Size.Small" Color="@(context.IsActive ? Color.Success : Color.Default)">
                        @(context.IsActive ? "活跃" : "停用")
                    </MudChip>
                </MudTd>
                <MudTd DataLabel="最后同步">@context.LastSyncAt.ToString("yyyy-MM-dd HH:mm")</MudTd>
                <MudTd DataLabel="操作">
                    <MudIconButton Icon="@Icons.Material.Filled.Info" Size="Size.Small" Color="Color.Info"
                                   OnClick="@(() => ShowDetails(context))" Title="查看详情" />
                    <MudIconButton Icon="@(context.IsActive ? Icons.Material.Filled.Stop : Icons.Material.Filled.PlayArrow)"
                                   Size="Size.Small" Color="@(context.IsActive ? Color.Warning : Color.Success)"
                                   OnClick="@(() => ToggleActive(context))"
                                   Title="@(context.IsActive ? "停用" : "启用")" />
                    <MudIconButton Icon="@Icons.Material.Filled.Delete" Size="Size.Small" Color="Color.Error"
                                   OnClick="@(() => DeleteAccount(context))" Title="删除账号" />
                </MudTd>
            </RowTemplate>
            <NoRecordsContent>
                <MudText>暂无账号数据，请先<MudLink Href="/accounts/import">导入账号</MudLink></MudText>
            </NoRecordsContent>
            <LoadingContent>
                <MudProgressCircular Indeterminate="true" />
            </LoadingContent>
        </MudTable>
    </MudCardContent>
</MudCard>

@code {
    private List<Account> accounts = new();
    private List<AccountCategory> categories = new();
    private bool loading = true;
    private string searchString = "";
    private int filterCategoryId = 0;

    private IEnumerable<Account> filteredAccounts =>
        accounts.Where(a =>
        {
            if (filterCategoryId > 0 && a.CategoryId != filterCategoryId)
                return false;

            if (string.IsNullOrWhiteSpace(searchString))
                return true;

            return a.Phone.Contains(searchString, StringComparison.OrdinalIgnoreCase)
                   || (a.Nickname?.Contains(searchString, StringComparison.OrdinalIgnoreCase) ?? false)
                   || (a.Username?.Contains(searchString, StringComparison.OrdinalIgnoreCase) ?? false)
                   || a.UserId.ToString().Contains(searchString);
        });

    protected override async Task OnInitializedAsync()
    {
        await LoadCategories();
        await LoadAccounts();
    }

    private async Task LoadCategories()
    {
        try
        {
            var list = await CategoryManagement.GetAllCategoriesAsync();
            categories = list.ToList();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"加载分类失败：{ex.Message}", Severity.Error);
        }
    }

    private async Task LoadAccounts()
    {
        loading = true;
        try
        {
            var accountList = await AccountManagement.GetAllAccountsAsync();
            accounts = accountList.ToList();
            await LoadCategories();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"加载失败：{ex.Message}", Severity.Error);
        }
        finally
        {
            loading = false;
        }
    }

    private async Task ShowDetails(Account account)
    {
        var (channels, groups) = await AccountManagement.GetAccountStatisticsAsync(account.Id);
        var message = $"账号详情：\n手机号：{account.Phone}\n用户名：{account.Username ?? "无"}\n用户ID：{account.UserId}\n分类：{account.Category?.Name ?? "未分类"}\n创建的频道：{channels} 个\n创建的群组：{groups} 个\n创建时间：{account.CreatedAt:yyyy-MM-dd HH:mm}\n最后同步：{account.LastSyncAt:yyyy-MM-dd HH:mm}\nSession路径：{account.SessionPath}";
        await DialogService.ShowMessageBox("账号详情", message, "关闭");
    }

    private async Task ToggleActive(Account account)
    {
        try
        {
            await AccountManagement.SetAccountActiveStatusAsync(account.Id, !account.IsActive);
            account.IsActive = !account.IsActive;
            Snackbar.Add($"账号已{(account.IsActive ? "启用" : "停用")}", Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"操作失败：{ex.Message}", Severity.Error);
        }
    }

    private async Task DeleteAccount(Account account)
    {
        bool? result = await DialogService.ShowMessageBox(
            "确认删除",
            $"确定要删除账号 {account.Phone} 吗？此操作不可撤销！",
            yesText: "删除", cancelText: "取消");

        if (result == true)
        {
            try
            {
                await AccountManagement.DeleteAccountAsync(account.Id);
                accounts.Remove(account);
                Snackbar.Add("账号已删除", Severity.Success);
            }
            catch (Exception ex)
            {
                Snackbar.Add($"删除失败：{ex.Message}", Severity.Error);
            }
        }
    }
}
