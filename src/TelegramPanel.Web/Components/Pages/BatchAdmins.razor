@page "/batch/admins"
@inject IChannelService ChannelService
@inject AccountManagementService AccountManagement
@inject ChannelManagementService ChannelManagement
@inject ChannelGroupManagementService ChannelGroupManagement
@inject BatchTaskManagementService TaskManagement
@inject ISnackbar Snackbar
@using TelegramPanel.Data.Entities
@using TelegramPanel.Core.Interfaces

<PageTitle>批量设置管理员 - Telegram Panel</PageTitle>

<MudText Typo="Typo.h4" Class="mb-4">批量设置管理员</MudText>

<MudGrid>
    <MudItem xs="12" md="6">
        <MudCard>
            <MudCardHeader>
                <MudText Typo="Typo.h6">配置管理员</MudText>
            </MudCardHeader>
            <MudCardContent>
                <MudSelect @bind-Value="selectedAccountId" Label="执行账号（可选）" Variant="Variant.Outlined">
                    <MudSelectItem Value="0">（默认：按频道创建账号执行）</MudSelectItem>
                    @foreach (var account in accounts)
                    {
                        <MudSelectItem Value="@account.Id">@account.Phone (@account.Username)</MudSelectItem>
                    }
                </MudSelect>

                <MudSelect @bind-Value="filterGroupId" Label="频道分组筛选（可选）" Variant="Variant.Outlined" Dense="true" Class="mt-4">
                    <MudSelectItem Value="0">全部分组</MudSelectItem>
                    @foreach (var g in groups)
                    {
                        <MudSelectItem Value="@g.Id">@g.Name</MudSelectItem>
                    }
                </MudSelect>

                <MudStack Row="true" Spacing="2" Class="mt-3">
                    <MudButton Variant="Variant.Outlined" Color="Color.Primary" StartIcon="@Icons.Material.Filled.SelectAll"
                               Disabled="@channelsLoading" OnClick="SelectAllFilteredChannels">
                        全选当前筛选
                    </MudButton>
                    <MudButton Variant="Variant.Outlined" Color="Color.Info" StartIcon="@Icons.Material.Filled.Checklist"
                               Disabled="@(channelsLoading || filterGroupId <= 0)" OnClick="SelectCurrentGroupChannels">
                        选择该分组全部
                    </MudButton>
                    <MudButton Variant="Variant.Text" Color="Color.Secondary" Disabled="@channelsLoading" OnClick="ClearSelectedChannels">
                        清空选择
                    </MudButton>
                </MudStack>

                <MudTable Items="@filteredChannels" Hover="true" Dense="true" Class="mt-3"
                          MultiSelection="true" @bind-SelectedItems="selectedChannels"
                          Loading="@channelsLoading">
                    <HeaderContent>
                        <MudTh>频道名称</MudTh>
                        <MudTh>分组</MudTh>
                        <MudTh>创建账号</MudTh>
                        <MudTh>用户名</MudTh>
                    </HeaderContent>
                    <RowTemplate>
                        <MudTd DataLabel="频道名称">@context.Title</MudTd>
                        <MudTd DataLabel="分组">@(context.Group?.Name ?? "未分组")</MudTd>
                        <MudTd DataLabel="创建账号">@(context.CreatorAccount?.Phone ?? context.CreatorAccountId.ToString())</MudTd>
                        <MudTd DataLabel="用户名">@(string.IsNullOrWhiteSpace(context.Username) ? "-" : "@" + context.Username)</MudTd>
                    </RowTemplate>
                    <NoRecordsContent>
                        <MudText>暂无频道数据</MudText>
                    </NoRecordsContent>
                </MudTable>

                <MudTextField @bind-Value="adminTitle" Label="管理员头衔" Variant="Variant.Outlined" Class="mt-4"
                              HelperText="可选，为管理员设置自定义头衔" />

                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2" Class="mt-4 mb-2">
                    <MudText Typo="Typo.h6">管理员权限</MudText>
                    <MudSpacer />
                    <MudButton Variant="Variant.Outlined" Size="Size.Small" OnClick="SelectAllPermissions">全选</MudButton>
                    <MudButton Variant="Variant.Outlined" Size="Size.Small" OnClick="ClearAllPermissions">全不选</MudButton>
                </MudStack>

                <MudCheckBox @bind-Value="permissions.ChangeInfo" Label="修改频道信息" />
                <MudCheckBox @bind-Value="permissions.PostMessages" Label="发布消息" />
                <MudCheckBox @bind-Value="permissions.EditMessages" Label="编辑消息" />
                <MudCheckBox @bind-Value="permissions.DeleteMessages" Label="删除消息" />
                <MudCheckBox @bind-Value="permissions.BanUsers" Label="封禁用户" />
                <MudCheckBox @bind-Value="permissions.InviteUsers" Label="邀请用户" />
                <MudCheckBox @bind-Value="permissions.PinMessages" Label="置顶消息" />
                <MudCheckBox @bind-Value="permissions.ManageCall" Label="管理语音聊天" />
                <MudCheckBox @bind-Value="permissions.ManageTopics" Label="管理话题" />
                <MudCheckBox @bind-Value="permissions.AddAdmins" Label="添加管理员" />
                <MudCheckBox @bind-Value="permissions.Anonymous" Label="匿名管理员（如支持）" />

                <MudTextField @bind-Value="usernames" Label="用户名列表" Variant="Variant.Outlined" Lines="8" Class="mt-4"
                              HelperText="每行一个用户名" />
            </MudCardContent>
            <MudCardActions>
                <MudButton Variant="Variant.Text" Color="Color.Secondary" OnClick="ClearForm">清空</MudButton>
                <MudSpacer />
                <MudButton Variant="Variant.Filled" Color="Color.Primary"
                           Disabled="@(selectedChannels.Count == 0 || string.IsNullOrEmpty(usernames) || processing)"
                           OnClick="StartSetAdmins">
                    @if (processing)
                    {
                        <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                        <span>设置中...</span>
                    }
                    else
                    {
                        <span>开始设置</span>
                    }
                </MudButton>
            </MudCardActions>
        </MudCard>
    </MudItem>

    <MudItem xs="12" md="6">
        <MudCard>
            <MudCardHeader>
                <MudText Typo="Typo.h6">设置结果</MudText>
            </MudCardHeader>
            <MudCardContent>
                <MudList T="string" Dense="true">
                    @foreach (var result in results)
                    {
                        <MudListItem T="string" Icon="@(result.Success ? Icons.Material.Filled.CheckCircle : Icons.Material.Filled.Error)"
                                     IconColor="@(result.Success ? Color.Success : Color.Error)">
                            <div>
                                <MudText Typo="Typo.body2">
                                    <strong>@result.ChannelTitle</strong>：@("@" + result.Username)
                                </MudText>
                                <MudText Typo="Typo.caption" Color="Color.Secondary">执行账号：@result.ExecutedByAccountId</MudText>
                                @if (!result.Success && result.Error != null)
                                {
                                    <MudText Typo="Typo.caption" Color="Color.Error">@result.Error</MudText>
                                }
                            </div>
                        </MudListItem>
                    }
                </MudList>
                @if (results.Any())
                {
                    <MudDivider Class="my-3" />
                    <MudText Typo="Typo.body2">
                        成功：@results.Count(r => r.Success) / 总计：@results.Count（频道：@results.Select(r => r.ChannelTelegramId).Distinct().Count()）
                    </MudText>
                }
            </MudCardContent>
        </MudCard>
    </MudItem>
</MudGrid>

@code {
    private List<Account> accounts = new();
    private List<Channel> channels = new();
    private List<ChannelGroup> groups = new();

    private int selectedAccountId = 0;
    private int filterGroupId = 0;
    private bool channelsLoading = true;
    private HashSet<Channel> selectedChannels = new();

    private string adminTitle = "Admin";
    private string usernames = "";
    private bool processing = false;

    private AdminPermissions permissions = new();
    private List<AdminSetOutcome> results = new();

    private IEnumerable<Channel> filteredChannels =>
        channels.Where(c => filterGroupId <= 0 || c.GroupId == filterGroupId);

    protected override async Task OnInitializedAsync()
    {
        await LoadAccounts();
        await LoadGroups();
        await LoadChannels();
    }

    private async Task LoadAccounts()
    {
        try
        {
            var accountList = await AccountManagement.GetActiveAccountsAsync();
            accounts = accountList.ToList();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"加载账号列表失败：{ex.Message}", Severity.Error);
        }
    }

    private async Task LoadGroups()
    {
        try
        {
            var list = await ChannelGroupManagement.GetAllGroupsAsync();
            groups = list.ToList();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"加载频道分组失败：{ex.Message}", Severity.Error);
        }
    }

    private async Task LoadChannels()
    {
        channelsLoading = true;
        try
        {
            var channelList = await ChannelManagement.GetAllChannelsAsync();
            channels = channelList.ToList();
            selectedChannels = selectedChannels.Where(c => channels.Any(x => x.Id == c.Id)).ToHashSet();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"加载频道列表失败：{ex.Message}", Severity.Error);
        }
        finally
        {
            channelsLoading = false;
        }
    }

    private void SelectAllFilteredChannels()
    {
        selectedChannels = filteredChannels.ToHashSet();
    }

    private void SelectCurrentGroupChannels()
    {
        if (filterGroupId <= 0)
            return;

        selectedChannels = channels.Where(c => c.GroupId == filterGroupId).ToHashSet();
    }

    private void ClearSelectedChannels()
    {
        selectedChannels = new HashSet<Channel>();
    }

    private void SelectAllPermissions()
    {
        permissions.ChangeInfo = true;
        permissions.PostMessages = true;
        permissions.EditMessages = true;
        permissions.DeleteMessages = true;
        permissions.BanUsers = true;
        permissions.InviteUsers = true;
        permissions.PinMessages = true;
        permissions.ManageCall = true;
        permissions.ManageTopics = true;
        permissions.AddAdmins = true;
        permissions.Anonymous = true;
    }

    private void ClearAllPermissions()
    {
        permissions.ChangeInfo = false;
        permissions.PostMessages = false;
        permissions.EditMessages = false;
        permissions.DeleteMessages = false;
        permissions.BanUsers = false;
        permissions.InviteUsers = false;
        permissions.PinMessages = false;
        permissions.ManageCall = false;
        permissions.ManageTopics = false;
        permissions.AddAdmins = false;
        permissions.Anonymous = false;
    }

    private async Task StartSetAdmins()
    {
        processing = true;
        results.Clear();

        try
        {
            var usernameList = usernames.Split('\n', StringSplitOptions.RemoveEmptyEntries)
                .Select(u => u.Trim().TrimStart('@'))
                .Where(u => !string.IsNullOrEmpty(u))
                .ToList();

            if (usernameList.Count == 0)
            {
                Snackbar.Add("请输入至少一个用户名", Severity.Warning);
                return;
            }

            var targetChannels = selectedChannels.ToList();
            if (targetChannels.Count == 0)
            {
                Snackbar.Add("请先勾选至少一个频道", Severity.Warning);
                return;
            }

            var rights = BuildAdminRights();

            var task = new BatchTask
            {
                TaskType = "set_admin",
                Total = usernameList.Count * targetChannels.Count,
                Completed = 0,
                Failed = 0,
                Config = System.Text.Json.JsonSerializer.Serialize(new
                {
                    ChannelIds = targetChannels.Select(c => c.TelegramId).ToList(),
                    ChannelTitles = targetChannels.Select(c => c.Title).ToList(),
                    Rights = rights.ToString(),
                    Title = adminTitle,
                    ExecutedByAccountId = selectedAccountId
                })
            };
            var createdTask = await TaskManagement.CreateTaskAsync(task);
            await TaskManagement.StartTaskAsync(createdTask.Id);

            var totalSuccess = 0;
            var totalFailed = 0;

            foreach (var channel in targetChannels)
            {
                var executeAccountId = selectedAccountId > 0 ? selectedAccountId : channel.CreatorAccountId;
                var adminRequests = usernameList.Select(u => new AdminRequest(u, rights, adminTitle)).ToList();

                List<SetAdminResult> setResults;
                try
                {
                    setResults = await ChannelService.BatchSetAdminsAsync(executeAccountId, channel.TelegramId, adminRequests);
                }
                catch (Exception ex)
                {
                    setResults = usernameList.Select(u => new SetAdminResult(u, false, ex.Message)).ToList();
                }

                foreach (var r in setResults)
                {
                    results.Add(new AdminSetOutcome(
                        ChannelTelegramId: channel.TelegramId,
                        ChannelTitle: channel.Title,
                        Username: r.Username,
                        Success: r.Success,
                        Error: r.Error,
                        ExecutedByAccountId: executeAccountId
                    ));
                }

                var successCount = setResults.Count(r => r.Success);
                var failedCount = setResults.Count - successCount;
                totalSuccess += successCount;
                totalFailed += failedCount;

                await TaskManagement.UpdateTaskProgressAsync(createdTask.Id, totalSuccess, totalFailed);
                StateHasChanged();
            }

            await TaskManagement.CompleteTaskAsync(createdTask.Id, true);
            Snackbar.Add($"设置完成：成功 {totalSuccess}，失败 {totalFailed}（频道：{targetChannels.Count}）", totalFailed == 0 ? Severity.Success : Severity.Warning);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"设置失败：{ex.Message}", Severity.Error);
        }
        finally
        {
            processing = false;
        }
    }

    private AdminRights BuildAdminRights()
    {
        var rights = AdminRights.None;
        if (permissions.ChangeInfo) rights |= AdminRights.ChangeInfo;
        if (permissions.PostMessages) rights |= AdminRights.PostMessages;
        if (permissions.EditMessages) rights |= AdminRights.EditMessages;
        if (permissions.DeleteMessages) rights |= AdminRights.DeleteMessages;
        if (permissions.BanUsers) rights |= AdminRights.BanUsers;
        if (permissions.InviteUsers) rights |= AdminRights.InviteUsers;
        if (permissions.PinMessages) rights |= AdminRights.PinMessages;
        if (permissions.ManageCall) rights |= AdminRights.ManageCall;
        if (permissions.ManageTopics) rights |= AdminRights.ManageTopics;
        if (permissions.AddAdmins) rights |= AdminRights.AddAdmins;
        if (permissions.Anonymous) rights |= AdminRights.Anonymous;
        return rights;
    }

    private void ClearForm()
    {
        usernames = "";
        results.Clear();
    }

    private class AdminPermissions
    {
        public bool ChangeInfo { get; set; } = true;
        public bool PostMessages { get; set; } = true;
        public bool EditMessages { get; set; } = true;
        public bool DeleteMessages { get; set; } = true;
        public bool BanUsers { get; set; }
        public bool InviteUsers { get; set; } = true;
        public bool PinMessages { get; set; } = true;
        public bool ManageCall { get; set; }
        public bool ManageTopics { get; set; }
        public bool AddAdmins { get; set; }
        public bool Anonymous { get; set; }
    }

    private record AdminSetOutcome(
        long ChannelTelegramId,
        string ChannelTitle,
        string Username,
        bool Success,
        string? Error,
        int ExecutedByAccountId
    );
}

